#!/usr/bin/env ruby
$LOAD_PATH.unshift File.expand_path('../../lib', __FILE__)
require 'language_classifier'
require 'madeleine'
require 'pp'

class TrainCommand

  def initialize(category, document)
    @category, @document = category, document
  end

  def execute(system)
    system.train(@category, @document)
  end

end

class ClassifyQuery
  def initialize(document)
    @document = document
  end

  def execute(system)
    system.classify(@document)
  end
end

class ClassifyInspect
  def execute(system)
    pp system.words
  end
end

madeleine = SnapshotMadeleine.new('tmp/language_classifier') do
  LanguageClassifier::Classifier.new
end

options = Hash.new
options[:command] = ARGV.first
ARGV.each do |arg|
  case arg
  when '-f'
    options[:file] = ARGV[ARGV.index(arg) + 1]
  when '-c'
    options[:category] = ARGV[ARGV.index(arg) + 1]
  end
end

case options[:command]
when "train"
  cmd = TrainCommand.new(options[:category], File.open(options[:file], "r").read)
  madeleine.execute_command(cmd)
  madeleine.take_snapshot
when "classify"
  cmd = ClassifyQuery.new(File.open(options[:file], "r").read)
  puts madeleine.execute_query(cmd)
when "seed"
  puts "SEEDING DATA FROM SAMPLES - excludes test files"
  %w[afrikaans danish english filipino french hungarian latin romanian].each do |category|
    puts "Seeding data with: #{category}"
    cmd = TrainCommand.new(category, File.open(File.expand_path('../../', __FILE__) + "/samples/#{category}.txt", "r").read)
    madeleine.execute_command(cmd)
  end
  madeleine.take_snapshot
when "inspect"
  cmd = ClassifyInspect.new
  madeleine.execute_query(cmd)
when "clear"
  madeleine.close
  Dir.delete(File.expand_path('../../', __FILE__) + "/tmp/language_classifier")
else
  puts "Arguments formatted incorrectly"
  puts
  puts "Training: bin/classify train -f FILE_PATH -c CATEGORY"
  puts "Classification: bin/classify classify -f FILE_PATH"
end
